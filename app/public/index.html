<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>FinSave – Historial</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .chart-container { position: relative; width:250px; height:250px; border-radius:50%; background: conic-gradient(#4CAF50 0% 60%, #2196F3 60% 85%, #FFC107 85% 100%); margin:auto; }
        .center-label { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:100px; height:100px; border-radius:50%; background:white; display:flex; justify-content:center; align-items:center; font-weight:bold; }
    </style>
    <style>
        body { background-color:#f6f5f7; }
        .card { border-radius:1rem; }
    </style>
    <style>.hidden{display:none !important}</style>

</head>





<body class="bg-light">
<section id="login-pantalla">
    <div class="card shadow p-4" style="max-width:400px; width:100%;">
        <div class="text-center mb-4">
            <h2>FinSave</h2>
            <p class="text-muted">Administra tus finanzas fácilmente</p>
        </div>

        <ul class="nav nav-tabs mb-3" id="authTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button">Login</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button">Registro</button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- LOGIN -->
            <div class="tab-pane fade show active" id="login">
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="email" class="form-control" id="emailLogin" placeholder="Correo" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="passwordLogin" placeholder="Contraseña" required>
                    </div>
                    <div class="mb-3 text-danger" id="loginMsg"></div>
                    <button class="btn btn-primary w-100" type="submit">Entrar</button>
                </form>
            </div>

            <!-- REGISTRO -->
            <div class="tab-pane fade" id="registro">
                <form id="registroForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="nombreRegistro" placeholder="Nombre" required>
                    </div>
                    <div class="mb-3">
                        <input type="email" class="form-control" id="emailRegistro" placeholder="Correo" required>
                    </div>
                    <div class="mb-3">
                        <input type="password" class="form-control" id="passwordRegistro" placeholder="Contraseña" required>
                    </div>
                    <div class="mb-3 text-success" id="registroMsg"></div>
                    <button class="btn btn-success w-100" type="submit">Registrarse</button>
                </form>
            </div>
        </div>
    </div>
</section>

<section id="website-pantalla" class="hidden">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">FinSave</a>
            <button class="btn btn-outline-danger" id="logoutBtn">Cerrar sesión</button>
        </div>
    </nav>

    <div class="container">
        <div class="text-center mb-4">
            <h2>Gráfico de Finanzas</h2>
            <div class="chart-container">
                <div class="center-label">100%</div>
            </div>
            <div class="d-flex justify-content-around mt-3">
                <span class="badge bg-success">Ingresos 60%</span>
                <span class="badge bg-primary">Gastos 25%</span>
                <span class="badge bg-warning text-dark">Ahorro 15%</span>
            </div>
        </div>

        <div class="mb-3 text-center">
            <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#movModal">Insertar movimiento</button>
            <button class="btn btn-success" id="exportBtn">Exportar CSV</button>
        </div>

        <div class="mb-3 d-flex">
            <input id="clienteId" class="form-control me-2" placeholder="ID Cliente">
            <button class="btn btn-secondary" onclick="verHistorial()">Ver Historial</button>
        </div>

        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>Tipo</th><th>Monto</th><th>Fecha</th><th>Descripción</th>
            </tr>
            </thead>
            <tbody id="tablaCuerpo"></tbody>
        </table>
    </div>

    <!-- Modal Movimiento -->
    <div class="modal fade" id="movModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuevo Movimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="nuevoRegistro">
                        <input id="inputTitulo" class="form-control mb-2" placeholder="Título" required>
                        <input id="inputClienteId" class="form-control mb-2" placeholder="ID Cliente" required>
                        <input id="inputMonto" type="number" step="0.01" class="form-control mb-2" placeholder="Monto" required>
                        <select id="objeto" class="form-select mb-2">
                            <option value="ingreso">Ingreso</option>
                            <option value="gasto">Gasto</option>
                        </select>
                        <select id="tag" class="form-select mb-2">
                            <option value="ocio">Ocio</option>
                            <option value="comida">Comida</option>
                            <option value="alquiler">Alquiler</option>
                            <option value="nomina">Nómina</option>
                            <option value="gasolina">Gasolina</option>
                        </select>
                        <input type="date" id="start" class="form-control mb-2" value="2025-01-01" min="2010-01-01" max="2040-12-31">
                        <button type="submit" class="btn btn-primary w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>














<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const loginSection = document.getElementById("login-pantalla");
    const appSection   = document.getElementById("website-pantalla");

    function showLogin(){
        appSection.classList.add("hidden");
        loginSection.classList.remove("hidden");
        loginSection.setAttribute("aria-hidden","false");
        appSection.setAttribute("aria-hidden","true");
        appSection.inert = true;
        loginSection.inert = false;
    }

    function showApp(){
        loginSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        loginSection.setAttribute("aria-hidden","true");
        appSection.setAttribute("aria-hidden","false");
        loginSection.inert = true;
        appSection.inert = false;
    }

    // initial state (run immediately since scripts are at the end of <body>)
    localStorage.getItem("token") ? showApp() : showLogin();


    document.getElementById("logoutBtn").addEventListener("click", ()=>{
        localStorage.removeItem("token");
        showLogin();
    });

    // Guardar movimiento
    document.getElementById("nuevoRegistro").addEventListener("submit", async e=>{
        e.preventDefault();
        const clienteId=document.getElementById("inputClienteId").value;
        const titulo=document.getElementById("inputTitulo").value;
        const monto=parseFloat(document.getElementById("inputMonto").value);
        const tipo=document.getElementById("objeto").value;
        const tag=document.getElementById("tag").value;
        const fecha=document.getElementById("start").value;
        await fetch('/movimientos',{method:'POST', headers:{"Content-Type":"application/json","Authorization":"Bearer "+localStorage.getItem("token")}, body:JSON.stringify({idCuenta:clienteId,tipo,monto,descripcion:`${titulo} - ${tag}`,fecha})});
        document.getElementById("nuevoRegistro").reset();
        var movModal = bootstrap.Modal.getInstance(document.getElementById('movModal'));
        movModal.hide();
        verHistorial();
    });

    // Ver historial
    async function verHistorial(){
        const id=document.getElementById("clienteId").value;
        const res=await fetch(`/historial/${id}`,{headers:{"Authorization":"Bearer "+localStorage.getItem("token")}});
        const data=await res.json();
        const tbody=document.getElementById("tablaCuerpo"); tbody.innerHTML="";
        if(data.length===0) tbody.innerHTML='<tr><td colspan="4" class="text-center">No hay registros</td></tr>';
        data.forEach(m=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`<td>${m.tipo}</td><td>$${m.monto.toFixed(2)}</td><td>${new Date(m.fecha).toLocaleDateString()}</td><td>${m.descripcion||""}</td>`;
            tbody.appendChild(tr);
        });
    }

    // Exportar CSV
    document.getElementById("exportBtn").addEventListener("click", ()=>window.location.href="/exportar");
</script>

<!-- Scripts de Login -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById("loginForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const correo = document.getElementById("emailLogin").value;
        const password = document.getElementById("passwordLogin").value;
        const res = await fetch("/login", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({correo,password})});
        const loginMsg = document.getElementById("loginMsg");
        if(res.ok){ const data = await res.json();
            localStorage.setItem("token",data.token);
        showApp()
        }
        else loginMsg.textContent="Credenciales inválidas";
    });

    document.getElementById("registroForm").addEventListener("submit", async (e)=>{
        e.preventDefault();
        const nombre = document.getElementById("nombreRegistro").value;
        const correo = document.getElementById("emailRegistro").value;
        const password = document.getElementById("passwordRegistro").value;
        const res = await fetch("/registro", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({nombre,correo,password})});
        const data = await res.json();
        document.getElementById("registroMsg").textContent = data.message;
    });
</script>
</body>
</html>
