<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSave – Panel de Usuario</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>

<body class="bg-gray-100 text-gray-900">

<!-- NAVBAR -->
<header class="w-full bg-white shadow-sm fixed top-0 left-0 z-50">
    <nav class="container mx-auto flex justify-between items-center px-6 py-3">

        <div class="flex items-center gap-2">
            <img src="favicon.png" class="w-10 h-10">
            <span class="text-xl font-bold text-blue-600">FinSave</span>
        </div>

        <!-- User Avatar -->
        <div class="relative">
            <button id="userAvatar"
                class="w-10 h-10 rounded-full bg-blue-600 text-white font-bold flex items-center justify-center cursor-pointer">
            </button>

            <div id="dropdown"
                class="hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-xl text-sm">
                <a href="index.html" class="block px-4 py-2 hover:bg-gray-100">Inicio</a>
                <button id="logoutBtn"
                    class="block w-full text-left px-4 py-2 hover:bg-gray-100 text-red-600">
                    Cerrar sesión
                </button>
            </div>
        </div>
    </nav>
</header>

<main class="pt-32 px-6">

    <div class="max-w-3xl mx-auto bg-white shadow-md rounded-xl p-8">

        <h1 class="text-2xl font-bold mb-6 text-blue-700">Perfil del Usuario</h1>

        <!-- Datos de usuario -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <div>
                <label class="font-semibold">Nombre</label>
                <input id="nombre" type="text"
                    class="mt-1 w-full p-2 border rounded-md focus:ring focus:ring-blue-200"
                />
            </div>

            <div>
                <label class="font-semibold">Correo</label>
                <input id="correo" type="email"
                    class="mt-1 w-full p-2 border rounded-md focus:ring focus:ring-blue-200"
                />
            </div>

            <div>
                <label class="font-semibold">Miembro desde</label>
                <input id="miembroDesde" disabled
                    class="mt-1 w-full p-2 border rounded-md bg-gray-200"
                />
            </div>

            <div>
                <label class="font-semibold">Balance</label>
                <input id="balance" disabled
                    class="mt-1 w-full p-2 border rounded-md bg-gray-200"
                />
            </div>

        </div>

        <hr class="my-8">

        <!-- AJUSTES -->
        <h2 class="text-xl font-bold text-blue-700 mb-4">Ajustes</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div>
                <label class="font-semibold">Idioma</label>
                <select id="idioma" class="w-full mt-1 p-2 border rounded-md">
                    <option value="es">Español</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div>
                <label class="font-semibold">Moneda</label>
                <select id="moneda" class="w-full mt-1 p-2 border rounded-md">
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div>
                <label class="font-semibold">Tema</label>
                <select id="tema" class="w-full mt-1 p-2 border rounded-md">
                    <option value="light">Claro</option>
                    <option value="dark">Oscuro</option>
                </select>
            </div>

        </div>

        <!-- BOTONES -->
        <div class="flex justify-end gap-4 mt-10">

            <button id="editarBtn"
                class="px-6 py-2 bg-white border border-blue-600 text-blue-600 rounded-md hover:bg-blue-50">
                Editar Perfil
            </button>

            <button id="guardarBtn"
                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Guardar
            </button>

        </div>

    </div>

</main>

<script>
/* ============================
   LOAD USER INFO
============================ */
async function cargarPerfil() {
    const token = localStorage.getItem("token");
    if (!token) return window.location.href = "login.html";

    try {
        const res = await fetch("/api/me", {
            headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();

        // Rellenar campos
        document.getElementById("nombre").value = data.nombre;
        document.getElementById("correo").value = data.correo;
        document.getElementById("miembroDesde").value = data.miembroDesde;
        document.getElementById("balance").value = data.balance + " " + data.moneda;

        document.getElementById("idioma").value = data.idioma;
        document.getElementById("moneda").value = data.moneda;
        document.getElementById("tema").value = data.tema;

        // Avatar iniciales
        const iniciales = data.nombre.split(" ").map(w => w[0]).join("").toUpperCase();
        document.getElementById("userAvatar").textContent = iniciales;

    } catch (err) {
        console.error(err);
    }
}

/* ============================
   SAVE PROFILE CHANGES
============================ */
document.getElementById("guardarBtn").addEventListener("click", async () => {
    const token = localStorage.getItem("token");

    const nombre = document.getElementById("nombre").value;
    const correo = document.getElementById("correo").value;

    const idioma = document.getElementById("idioma").value;
    const moneda = document.getElementById("moneda").value;
    const tema = document.getElementById("tema").value;

    try {
        // Guardar nombre/correo
        await fetch("/api/me", {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ nombre, correo })
        });

        // Guardar settings
        await fetch("/api/settings", {
            method: "PUT",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ idioma, moneda, tema })
        });

        alert("Cambios guardados correctamente.");
        cargarPerfil();

    } catch (err) {
        console.error(err);
    }
});

/* ============================
   TOGGLE DROPDOWN
============================ */
document.getElementById("userAvatar").addEventListener("click", () => {
    document.getElementById("dropdown").classList.toggle("hidden");
});

/* ============================
   LOGOUT
============================ */
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
});

/* Inicializar */
cargarPerfil();
</script>

</body>
</html>
